1. USER INTENT (The "Why")
Goal: Create a persistent, web-based prompt and image library that automatically tracks every generation from the Save Image (LoraManager) node.

Problem: ComfyUI doesn't have a native, permanent "history" with a clean UI that persists across sessions and allows for quick database-style searching.

Solution: A custom webpage hosted locally that scans the output folder, extracts the LoRA/Checkpoint metadata, and stores it in a searchable local database with an auto-pruning feature.

2. FUNCTIONAL REQUIREMENTS
Backend (Python/Custom Node)
Metadata Extraction: Use the Pillow (PIL) library to read the prompt and extra_pnginfo from PNG files saved by the LoRA Manager.

Watchdog/Scanner: A background service that monitors the comfyui/output folder for new files.

Database (SQLite): Store entries including: image_path, checkpoint, loras (list of names and strengths), positive_prompt, negative_prompt, and timestamp.

Auto-Delete Logic: A setting (default 500) that removes the oldest database entries (and optionally the physical files) when the limit is reached.

Frontend (Web Dashboard)
Grid View: Display images with their associated prompts.

Filter System: Search by specific LoRA name, Checkpoint, or keywords in the prompt.

Customization UI: A settings toggle for the user to set the "History Limit" (e.g., change 500 to 1000).

Import Button: A "Manual Scan" button to re-index the entire output folder for first-time setup.

3. GURU RESEARCH NOTES
Based on research into similar nodes:

Metadata Format: Save Image (LoraManager) embeds a JSON string into the PNG tEXt or iTXt chunks. It typically uses the key prompt for the workflow and extra_pnginfo for the node-specific data.

LoRA Handling: Unlike standard CLIP encoders, the LoRA manager often stores LoRAs as <lora:name:strength>. The scanner must use a Regex pattern ([a-zA-Z0-9_\-]+):([0-9.]+) to extract these properly.

Best Practice: Don't just store the image path; store a base64 thumbnail or a low-res preview in the database to keep the web gallery fast even if the output folder is on a slow HDD.

4. UI/UX PREFERENCES
Theme: Dark mode by default (matching ComfyUI aesthetic).

Interactivity: Clicking a LoRA name in the history should copy that LoRA's syntax to the clipboard.

Layout: Masonry grid for images (like Pinterest or Civitai).

5. SUCCESS CRITERIA
[ ] Successfully parses a PNG generated by Save Image (LoraManager) and extracts the Checkpoint name.

[ ] Database correctly increments to 501 and then deletes entry #1.

[ ] The custom webpage loads inside the "Webpage Loader" node without CORS errors.

[ ] "Scan Output" finds and imports at least 10 images in under 2 seconds.

6. ## TECHNICAL IMPLEMENTATION: LOCAL WEB SERVER
- **Host:** Integrated into ComfyUI PromptServer (Port 8188 or user default).
- **Access URL:** `/extensions/[node_name]/index.html` or a custom registered route.
- **Database:** SQLite file named `history_guru.db` stored in the custom node folder.
- **Image Serving:** Use ComfyUI's internal `/view` endpoint to display images in the gallery to avoid permission issues.