<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>History Guru v6.10 (Tag Hunter)</title>
<style>
:root{--bg:#09090b;--head:rgba(9,9,11,0.98);--side:#0c0c0e;--card:#18181b;--bd:#27272a;--acc:#8b5cf6;--txt:#e4e4e7;--mut:#a1a1aa}
[data-theme="light"]{--bg:#f8f9fa;--head:#ffffff;--side:#f1f3f4;--card:#ffffff;--bd:#dadce0;--acc:#1a73e8;--txt:#202124;--mut:#5f6368}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,sans-serif;height:100vh;display:flex;flex-direction:column;overflow:hidden;transition:background-color 0.3s ease,color 0.3s ease}
header{height:60px;border-bottom:1px solid var(--bd);display:flex;align-items:center;padding:0 20px;background:var(--head);gap:16px;z-index:50}
h1{font-size:1.1rem;font-weight:800;margin:0;white-space:nowrap}h1 span{color:var(--acc)}
.s-box{flex:1;max-width:500px;position:relative}.s-in{width:100%;background:#121214;border:1px solid var(--bd);color:var(--txt);padding:8px 12px 8px 36px;border-radius:8px;outline:none}
.s-in:focus{border-color:var(--acc)}.btn{background:var(--acc);color:#fff;border:none;padding:8px 16px;border-radius:8px;font-weight:600;cursor:pointer;font-size:0.85rem}
.btn-icon{padding:8px;background:transparent;border:1px solid var(--bd);color:var(--mut);border-radius:6px;cursor:pointer;display:flex}.btn-icon.active{background:var(--acc);border-color:var(--acc);color:#fff}
.layout{display:flex;flex:1;overflow:hidden;position:relative}
.sidebar{width:240px;background:var(--side);border-right:1px solid var(--bd);display:flex;flex-direction:column;flex-shrink:0;transition:margin-left 0.2s}
.sidebar.collapsed{margin-left:-240px}.tree{flex:1;overflow-y:auto;padding:8px 0}
.folder{padding:6px 16px;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:0.85rem;color:var(--mut);white-space:nowrap;overflow:hidden;border:1px solid transparent}
.folder:hover{background:#27272a;color:var(--txt)}.folder.active{background:#3f3f46;color:#fff;border-left:3px solid var(--acc)}
.folder.drag-over{background:rgba(139,92,246,0.2);border-color:var(--acc);color:#fff}
.stage{flex:1;position:relative;display:flex;flex-direction:column;overflow:hidden;background:var(--bg)}
.toolbar{padding:8px 20px;border-bottom:1px solid var(--bd);display:flex;justify-content:space-between;align-items:center;font-size:0.85rem}
.grid-scroll{flex:1;overflow-y:auto;padding:20px}.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:16px;padding-bottom:100px}
.card{aspect-ratio:1;background:var(--card);border:1px solid var(--bd);border-radius:12px;overflow:hidden;cursor:pointer;position:relative}
.card:hover{border-color:var(--acc);transform:translateY(-4px)}.card img,.card video{width:100%;height:100%;object-fit:cover;pointer-events:none}
.list-head{display:grid;grid-template-columns:55px 3fr 2fr 1.5fr 1fr;gap:12px;padding:10px 16px;border-bottom:1px solid var(--bd);font-size:0.75rem;color:var(--mut);font-weight:700;position:sticky;top:0;background:var(--bg);z-index:10}
.list-head>div{cursor:pointer;user-select:none;display:flex;align-items:center;gap:4px;transition:color 0.2s}
.list-head>div:hover{color:var(--acc)}
.list-head>div:first-child{cursor:default}
.list-head>div.sortable:hover{color:var(--txt)}
.list-head>div.sorted{color:var(--acc)}
.sort-arrow{font-size:0.7rem;opacity:0.6}
.list-head>div.sorted .sort-arrow{opacity:1}
.list-row{display:grid;grid-template-columns:55px 3fr 2fr 1.5fr 1fr;gap:12px;padding:6px 16px;border-bottom:1px solid #1f1f22;align-items:center;font-size:0.85rem;cursor:pointer;height:55px}
.list-row:hover{background:#27272a}.list-img{width:37px;height:37px;border-radius:4px;object-fit:cover;background:#000}
.detail-layer{position:absolute;inset:0;background:#000;z-index:2000;display:flex;flex-direction:column;visibility:hidden;opacity:0;transition:opacity 0.2s}
.detail-layer.active{visibility:visible;opacity:1}
.detail-mid{flex:1;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;background:#09090b}
.detail-media{max-width:100%;max-height:100%;object-fit:contain;box-shadow:0 0 50px rgba(0,0,0,0.5)}
.nav-btn{position:absolute;top:50%;transform:translateY(-50%);background:rgba(0,0,0,0.5);color:#fff;border:none;width:50px;height:50px;border-radius:50%;cursor:pointer;font-size:1.5rem;display:flex;align-items:center;justify-content:center;z-index:2010}
.nav-btn:hover{background:var(--acc)}.nav-prev{left:20px}.nav-next{right:20px}
.back-pill{position:absolute;top:20px;left:20px;background:rgba(0,0,0,0.6);color:#fff;padding:8px 16px;border-radius:20px;cursor:pointer;border:1px solid rgba(255,255,255,0.2);z-index:2010}
.detail-favorite-star{position:absolute;top:20px;right:20px;background:rgba(0,0,0,0.6);color:#fff;padding:8px;border-radius:50%;cursor:pointer;border:1px solid rgba(255,255,255,0.2);z-index:2010;width:40px;height:40px;display:flex;align-items:center;justify-content:center;font-size:1.5rem;transition:all 0.2s}
.detail-favorite-star:hover{background:rgba(0,0,0,0.8);transform:scale(1.1)}
.detail-favorite-star.favorited{background:rgba(251,191,36,0.3);border-color:#fbbf24}
.inspector{width:400px;background:var(--side);border-left:1px solid var(--bd);display:flex;flex-direction:column;flex-shrink:0;z-index:95;transition:transform 0.3s}
body.mode-list .inspector{position:fixed;right:0;top:60px;bottom:0;transform:translateX(100%)} body.mode-list .inspector.open{transform:translateX(0)}
body.mode-detail .inspector{position:relative;transform:none;border-left:1px solid #333}
.insp-head{height:60px;padding:0 20px;border-bottom:1px solid var(--bd);display:flex;justify-content:space-between;align-items:center;background:var(--head);flex-shrink:0}
.insp-scroll{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:16px}
.stats-box{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}.stat-cell{background:#121214;border:1px solid var(--bd);padding:8px;border-radius:8px}
.lbl{font-size:0.65rem;color:var(--mut);font-weight:700;text-transform:uppercase;display:block;margin-bottom:4px}
.val{width:100%;background:transparent;border:none;color:#fff;font-family:monospace;font-size:0.8rem;outline:none}
.prompt-area{background:#121214;border:1px solid var(--bd);border-radius:8px;padding:12px;font-family:monospace;font-size:0.8rem;line-height:1.5;color:#d4d4d8;width:100%;min-height:100px;resize:vertical;outline:none}
.chip{font-size:0.75rem;padding:4px 10px;border-radius:6px;background:rgba(139,92,246,0.15);color:#c4b5fd;border:1px solid rgba(139,92,246,0.3);display:inline-block;margin:2px}
.bot-bar{display:flex;gap:10px}.btn-full{flex:1;padding:12px;border-radius:8px;background:#27272a;color:#fff;border:none;cursor:pointer;font-weight:600}.btn-pri{background:var(--acc)}
.overlay{position:fixed;inset:0;background:rgba(9,9,11,0.95);z-index:3000;display:flex;flex-direction:column;align-items:center;justify-content:center}.hidden{display:none}
.spin{width:40px;height:40px;border:4px solid #333;border-top-color:var(--acc);border-radius:50%;animation:s 1s linear infinite;margin-bottom:20px}@keyframes s{to{transform:rotate(360deg)}}
body.mode-detail .folder-sidebar,body.mode-detail .toolbar{display:none} body.mode-list .detail-layer{display:none}
.stats-view{padding:0}.stat-card{background:var(--card);border:1px solid var(--bd);border-radius:12px;padding:20px;margin-bottom:20px}.stat-card h3{color:var(--acc);margin:0 0 15px 0;font-size:1.1rem;border-bottom:1px solid var(--bd);padding-bottom:10px}.stat-item{margin:8px 0;color:var(--txt);font-size:0.9rem;display:flex;justify-content:space-between}.stat-item strong{color:var(--acc)}
.card.favorite{border-color:#fbbf24}.card.selected{border-color:var(--acc)!important;box-shadow:0 0 10px rgba(139,92,246,0.5)}.list-row.selected{background:rgba(139,92,246,0.2)!important}.favorite-star{position:absolute;top:8px;right:8px;font-size:1.2rem;cursor:pointer;background:rgba(0,0,0,0.5);border-radius:50%;width:24px;height:24px;display:flex;align-items:center;justify-content:center;transition:opacity 0.2s;opacity:0.7;z-index:10}.favorite-star:hover{opacity:1}.card:hover .favorite-star{opacity:1}
.toast{position:fixed;bottom:20px;right:20px;background:var(--card);border:1px solid var(--bd);border-radius:8px;padding:12px 20px;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:10000;display:flex;align-items:center;gap:12px;min-width:250px;animation:toastSlide 0.3s ease}.toast.success{border-left:4px solid #4ade80}.toast.error{border-left:4px solid #ef4444}.toast.info{border-left:4px solid var(--acc)}@keyframes toastSlide{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
.context-menu{position:fixed;background:var(--card);border:1px solid var(--bd);border-radius:8px;padding:4px 0;min-width:150px;z-index:10000;box-shadow:0 4px 12px rgba(0,0,0,0.3);display:none}.context-menu-item{padding:8px 16px;cursor:pointer;color:var(--txt);font-size:0.85rem}.context-menu-item:hover{background:var(--side)}.context-menu-item.disabled{opacity:0.5;cursor:not-allowed}
</style>
</head>
<body class="mode-list" data-theme="dark">
<header>
    <h1>History<span>Guru</span> <span class="version">v6.10</span></h1>
    <div class="s-box"><input type="text" id="sIn" class="s-in" placeholder="Search..."></div>
    <button class="btn" onclick="initFileSystem()">Open Folder</button>
    <button class="btn" style="background:transparent;border:1px solid #333" onclick="fullScan()">‚Üª</button>
    <div style="width:1px;height:24px;background:#333"></div>
    <button id="bStats" class="btn-icon" onclick="setView('stats')">üìä</button>
    <button id="themeToggle" class="btn-icon" onclick="toggleTheme()" title="Toggle Theme">üåô</button>
    <button id="helpBtn" class="btn-icon" onclick="showHelp()" title="Help & Shortcuts">‚ùì</button>
    <button id="dupBtn" class="btn-icon" onclick="findDuplicates()" title="Find Duplicates">üîç</button>
    <button id="favFilterBtn" class="btn-icon" onclick="toggleFavoritesFilter()" title="Show Only Favorites">‚≠ê</button>
    <select id="sortSelect" class="btn" style="padding:8px 12px;font-size:0.85rem;" onchange="changeSort()" title="Sort By">
        <option value="date">Date Modified</option>
        <option value="name">Name</option>
        <option value="created">Date Created</option>
    </select>
</header>
<div class="layout">
    <aside id="sidebar" class="sidebar">
        <div style="padding:12px 16px;border-bottom:1px solid var(--bd);display:flex;justify-content:space-between;color:var(--mut);font-weight:700;font-size:0.75rem"><span>DIRECTORIES</span><span style="cursor:pointer;font-size:1.2rem" onclick="mkDir()">+</span></div>
        <div id="tree" class="tree"></div>
    </aside>
    <div class="stage">
        <div id="gridToolbar" class="toolbar"><div id="pathDisplay">Root</div><span id="fCount" style="color:var(--mut)">0 items</span></div>
        <div class="grid-scroll"><div id="grid" class="grid"></div></div>
        <div id="detailView" class="detail-layer">
            <button class="back-pill" onclick="exitDetail()">‚Üê Back (Esc)</button>
            <button id="detailFavoriteStar" class="detail-favorite-star" onclick="toggleFavoriteFromDetail()" title="Toggle Favorite">‚òÜ</button>
            <div class="detail-mid">
                <button class="nav-btn nav-prev" onclick="nav(-1)">‚Äπ</button>
                <div id="mediaCon" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center"></div>
                <button class="nav-btn nav-next" onclick="nav(1)">‚Ä∫</button>
            </div>
        </div>
    </div>
    <aside id="inspector" class="inspector">
        <div class="insp-head">
            <div><span class="lbl">METADATA</span><div id="mFile" style="font-family:monospace;font-size:0.85rem">filename.png</div></div>
            <button onclick="togInsp(false)" style="background:none;border:none;color:#fff;cursor:pointer">‚úï</button>
        </div>
        <div class="insp-scroll">
            <div class="stats-box">
                <div class="stat-cell"><span class="lbl">Model</span><input id="mModel" class="val" placeholder="?"></div>
                <div class="stat-cell"><span class="lbl">Size</span><input id="mSize" class="val" placeholder="?"></div>
                <div class="stat-cell"><span class="lbl">Sampler</span><input id="mSamp" class="val" placeholder="?"></div>
                <div class="stat-cell"><span class="lbl">Seed</span><input id="mSeed" class="val" placeholder="?"></div>
                <div class="stat-cell"><span class="lbl">Steps</span><input id="mSteps" class="val" placeholder="?"></div>
                <div class="stat-cell"><span class="lbl">CFG</span><input id="mCfg" class="val" placeholder="?"></div>
            </div>
            <div><span class="lbl" style="color:#4ade80">Positive</span><textarea id="mPos" class="prompt-area" spellcheck="false"></textarea></div>
            <div><span class="lbl" style="color:#f87171">Negative</span><textarea id="mNeg" class="prompt-area" spellcheck="false"></textarea></div>
            <div><span class="lbl">Resources</span><div id="mRes"></div></div>
            <div class="bot-bar"><button class="btn-full" onclick="saveJSON()">JSON</button><button class="btn-full btn-pri" onclick="fixSave()">Fix & Save</button></div>
        </div>
    </aside>
</div>
<div id="load" class="overlay hidden"><div class="spin"></div><h3>Processing...</h3></div>
<div id="wel" class="overlay"><h2>History Guru v6.10</h2><p style="color:#888;margin-bottom:20px">Hello Creator</p><button class="btn" onclick="initFileSystem()">Open Folder</button></div>
<div id="contextMenu" class="context-menu">
    <div class="context-menu-item" onclick="contextDelete()" style="color:#ef4444">Delete</div>
</div>
<div id="helpOverlay" class="overlay hidden">
    <div style="background:var(--side);border:1px solid var(--bd);border-radius:12px;padding:30px;max-width:900px;width:90%;max-height:85vh;overflow-y:auto;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <h2 style="color:var(--acc);margin:0;">‚ùì Help & Shortcuts</h2>
            <button class="btn" style="background:transparent;border:1px solid var(--bd);color:var(--txt);" onclick="hideHelp()">‚úï</button>
        </div>
        <div id="helpContent"></div>
    </div>
</div>

<script>
// STATE
let rH=null,db=null,cache=new Map(),fReg=new Map(),dReg=new Map();
let cDir=null,cFiles=[],vMode='list',aIdx=-1,cItem=null,favorites=new Set(),showFavoritesOnly=false,sortBy='date',sortDirection='desc',selectedIndex=-1,selectedItems=new Set();
const DB="GuruV610", LR=/<lora:([^:>]+)(?::([^:>]+))?(?::([^:>]+))?>/g;

// DB
const iDB=()=>new Promise((r,j)=>{const q=indexedDB.open(DB,1);q.onupgradeneeded=e=>{if(!e.target.result.objectStoreNames.contains("i"))e.target.result.createObjectStore("i",{keyPath:"p"})};q.onsuccess=e=>{db=e.target.result;r()};q.onerror=j});
const dPut=i=>new Promise(r=>{const t=db.transaction("i","readwrite");t.objectStore("i").put(i);t.oncomplete=r});
const dDel=k=>new Promise(r=>{const t=db.transaction("i","readwrite");t.objectStore("i").delete(k);t.oncomplete=r});
const dAll=()=>new Promise(r=>{const t=db.transaction("i","readonly");t.objectStore("i").getAll().onsuccess=e=>{e.target.result.forEach(x=>cache.set(x.p,x));r()}});

// FS
async function initFileSystem(){try{rH=await window.showDirectoryPicker({mode:"readwrite"});document.getElementById('wel').classList.add('hidden');document.getElementById('load').classList.remove('hidden');await iDB();await fullScan();}catch(e){alert("Access denied.")}}
async function fullScan(){document.getElementById('load').classList.remove('hidden');cache.clear();fReg.clear();dReg.clear();dReg.set('',rH);await dAll();await scD(rH,"");rTree();await opD(rH,"");document.getElementById('load').classList.add('hidden')}
async function scD(h,p){for await(const e of h.values()){const ep=p?`${p}/${e.name}`:e.name;if(e.kind==='directory'){dReg.set(ep,e);await scD(e,ep)}else if(/\.(png|jpg|jpeg|webp|mp4|webm)$/i.test(e.name)){fReg.set(ep,e);if(!cache.has(ep))await proc(e,ep)}}}

// --- BRAIN (Accumulative Fix) ---
async function decompressZlib(data) {try {const ds = new DecompressionStream('deflate-raw'); const writer = ds.writable.getWriter(); writer.write(data.slice(2, data.length - 4)); writer.close(); return new TextDecoder().decode(await new Response(ds.readable).arrayBuffer());} catch (e) {try {const ds = new DecompressionStream('deflate'); const writer = ds.writable.getWriter(); writer.write(data); writer.close(); return new TextDecoder().decode(await new Response(ds.readable).arrayBuffer());} catch(e2) { return null; }}}
async function extractText(buffer) {
    const view = new DataView(buffer); 
    let fullText = ""; 
    try {
        if (view.getUint32(0) === 0x89504E47) {
            let offset = 8; 
            while (offset < view.byteLength) {
                if (offset + 4 > view.byteLength) break; 
                const len = view.getUint32(offset); 
                const type = String.fromCharCode(...new Uint8Array(buffer, offset + 4, 4)); 
                if (offset + 8 + len > view.byteLength) break; 
                const data = new Uint8Array(buffer, offset + 8, len); 
                if (type === 'tEXt' || type === 'iTXt') {
                    try {
                        fullText += new TextDecoder('utf-8').decode(data).replace(/\0/g, '') + "\n";
                    } catch(e) {
                        fullText += new TextDecoder('latin1').decode(data).replace(/\0/g, '') + "\n";
                    }
                } else if (type === 'zTXt') { 
                    const inflated = await decompressZlib(data); 
                    if (inflated) fullText += inflated + "\n"; 
                } 
                offset += len + 12; 
                if (type === 'IEND') break;
            }
        } else if (view.getUint32(0) === 0x52494646 || view.getUint16(0) === 0xFFD8) {
            fullText = new TextDecoder().decode(new Uint8Array(buffer));
        }
    } catch(e) {
        console.warn('Metadata extraction error:', e);
    }
    return fullText;
}
function parseMetadata(text) {function extractJSON(str,startPos=0) {const start = str.indexOf('{',startPos); if (start === -1) return null; let count = 0, end = -1; for (let i = start; i < str.length; i++) { if (str[i] === '{') count++; else if (str[i] === '}') count--; if (count === 0) { end = i; break; } } if (end !== -1) try { return {json:JSON.parse(str.substring(start, end + 1)),end:end+1}; } catch(e) { return null; } return null;} let comfyResult=null;if (text.includes('"class_type"') && text.includes('"inputs"')) { let pos=0;while(true){const result=extractJSON(text,pos);if(!result)break;const json=result.json;pos=result.end;if(json&&(json.class_type||json.nodes||Object.values(json).some(v=>v&&typeof v==='object'&&(v.class_type||v.type)))){const parsed=parseComfy(json);if(parsed&&(parsed.pos||parsed.meta.model!=="?")){comfyResult=parsed;break}}}} if(!comfyResult&&(text.includes('"class_type"') || text.includes('"type"') || (text.includes('"inputs"') && (text.includes('KSampler') || text.includes('CLIPTextEncode') || text.includes('SaveImage') || text.includes('CLIPLoader') || text.includes('VAELoader'))))) { let pos=0;while(true){const result=extractJSON(text,pos);if(!result)break;const json=result.json;pos=result.end;if(json&&(json.class_type||json.nodes||json.type||Object.values(json).some(v=>v&&typeof v==='object'&&(v.class_type||v.type)))){const parsed=parseComfy(json);if(parsed&&(parsed.pos||parsed.meta.model!=="?")){comfyResult=parsed;break}}}} if(comfyResult)return comfyResult;return parseA1111(text);}

function parseComfy(json) {
    let pos="", neg="", meta={model:"?",size:"?",seed:"?",steps:"?",cfg:"?",sampler:"?"}, resources=[];
    let nodes = [];
    let nodeMap = {};
    if(json.nodes&&Array.isArray(json.nodes)){nodes=json.nodes.map(n=>{const node={class_type:n.type||n.data?.class_type||"",inputs:n.inputs||n.data?.inputs||n.widgets_values?{}:{}};if(n.id!==undefined)nodeMap[n.id]=node;return node}).filter(n=>n.class_type||n.inputs)}else{const vals=Object.values(json);nodes=vals.filter(n=>n&&typeof n==='object'&&(n.class_type||n.inputs));vals.forEach((n,i)=>{if(n&&typeof n==='object'&&(n.class_type||n.inputs)){const key=Object.keys(json)[i];if(key&&!isNaN(key))nodeMap[key]=n}})}
    
    // NEW ACCUMULATIVE RECURSION
    const findUpstreamText=(l,d=0)=>{
        if(d>10||!l||!Array.isArray(l))return"";
        let n=null;if(typeof l[0]==='string'||typeof l[0]==='number'){n=json[l[0]]||nodeMap[l[0]]}else if(typeof l[0]==='object'){n=l[0]}if(!n)return"";const inputs=n.inputs||{};if(!inputs&&!n.widgets_values)return"";
        let t = "";
        // 1. Local Text (from widgets_values for workflow format)
        if(Array.isArray(n.widgets_values)&&n.widgets_values.length>0&&typeof n.widgets_values[0]==='string')t+=n.widgets_values[0];
        // 2. Local Text (from inputs for prompt format)
        if(typeof inputs.text==='string') t+=(t?", ":"")+inputs.text;
        if(typeof inputs.text_g==='string') t+=(t?", ":"")+inputs.text_g;
        if(typeof inputs.text_l==='string') t+=(t?", ":"")+inputs.text_l;
        if(inputs.string_field) t+=(t?", ":"")+inputs.string_field;
        // 2. Special Lists (StandardTriggerWordsLoader)
        if(inputs.trigger_words_display && Array.isArray(inputs.trigger_words_display.__value__)) {
            const tags = inputs.trigger_words_display.__value__.filter(x=>x.active).map(x=>x.text).join(", ");
            if(tags) t+=(t?", ":"")+tags;
        }
        // 3. Recurse Keys
        const keys=['positive','negative','conditioning','clip','prompt','trigger_words']; // Added trigger_words
        for(const k of keys) if(inputs[k]) {
            const r = findUpstreamText(inputs[k],d+1);
            if(r) t+=(t?", ":"")+r;
        }
        return t;
    };

    const findUpstreamModel=(l,d=0)=>{if(d>10||!l||!Array.isArray(l))return"";let n=null;if(typeof l[0]==='string'||typeof l[0]==='number'){n=json[l[0]]||nodeMap[l[0]]}else if(typeof l[0]==='object'){n=l[0]}if(!n)return"";const inputs=n.inputs||{};if(inputs.ckpt_name)return inputs.ckpt_name;if(inputs.unet_name)return inputs.unet_name;if(inputs.checkpoint_name)return inputs.checkpoint_name;if(inputs.model_name)return inputs.model_name;if(inputs.model)return findUpstreamModel(inputs.model,d+1);return""};
    const samplerTypes = ["KSampler", "KSamplerAdvanced", "SamplerCustom", "SamplerEulerAncestralCFGPP", "SamplerLCM"];
    const ksampler=nodes.find(n=>n.class_type&&samplerTypes.some(type=>n.class_type.includes(type)));
    if(ksampler){const inputs=ksampler.inputs||{};meta.seed=inputs.seed||inputs.noise_seed||"?";meta.steps=inputs.steps||"?";meta.cfg=inputs.cfg||"?";meta.sampler=inputs.sampler_name||ksampler.class_type||"?";if(inputs.scheduler)meta.sampler+=" "+inputs.scheduler;if(inputs.positive)pos=findUpstreamText(inputs.positive);if(inputs.negative)neg=findUpstreamText(inputs.negative);if(inputs.model)meta.model=findUpstreamModel(inputs.model).replace(/\.(safetensors|ckpt)$/,"")}
    
    nodes.forEach(n=>{
        const nodeType = n.class_type || "";
        const inputs = n.inputs || {};
        if(inputs.lora_name) resources.push({type:'LoRA', name:inputs.lora_name.replace(/\.(safetensors|ckpt)$/,""), str:inputs.strength_model});
        if(nodeType.includes("Power Lora Loader")) for(const [k,v] of Object.entries(inputs)) if(k.startsWith('lora_')&&v?.on) resources.push({type:'LoRA', name:v.lora.replace(/\.(safetensors|ckpt)$/,""), str:v.strength});
        if(inputs.loras&&Array.isArray(inputs.loras.__value__)) inputs.loras.__value__.forEach(l=>{if(l.name&&l.active!==false)resources.push({type:'LoRA', name:l.name, str:l.strength})});
        if(nodeType.includes("ControlNet") && inputs.control_net_name) resources.push({type:'ControlNet', name:inputs.control_net_name, str:inputs.strength || "1.0"});
        if(nodeType.includes("IPAdapter") && inputs.ipadapter_file) resources.push({type:'IP-Adapter', name:inputs.ipadapter_file, str:inputs.weight || "1.0"});
    });
    const sizeNodes = ["EmptyLatentImage", "LatentUpscale", "LatentComposite", "EmptySD3LatentImage"];
    const sizeNode=nodes.find(n=>sizeNodes.includes(n.class_type));if(sizeNode){const inputs=sizeNode.inputs||{};if(inputs.width&&inputs.height)meta.size=`${inputs.width}x${inputs.height}`}
    return {pos,neg,meta,resources};
}

function parseA1111(text) {
    let pos="", neg="", resources=[], meta={model:"?",seed:"?",steps:"?",cfg:"?",sampler:"?",size:"?"}, match;
    LR.lastIndex=0; while((match=LR.exec(text))!==null) resources.push({type:'LoRA', name:match[1], str:match[2]||"1.0"});
    const negIdx=text.indexOf("Negative prompt:"); const stepsIdx=text.indexOf("Steps:");
    if(negIdx!==-1&&stepsIdx!==-1){pos=text.substring(0,negIdx).replace(/parameters\s*/i,"").trim();neg=text.substring(negIdx+16,stepsIdx).trim()}else if(stepsIdx!==-1)pos=text.substring(0,stepsIdx).trim();
    if(stepsIdx!==-1){const b=text.substring(stepsIdx);const get=k=>{const m=b.match(new RegExp(`${k}:\\s*([^,]+)`));return m?m[1].trim():"?"};meta.steps=get("Steps");meta.sampler=get("Sampler");meta.cfg=get("CFG scale");meta.seed=get("Seed");meta.size=get("Size");meta.model=get("Model");}
    return {pos,neg,resources,meta};
}

// --- LOGIC ---
async function proc(h,p){try{const f=await h.getFile(),vid=/\.(mp4|webm)$/i.test(f.name);let m=null;if(vid)m={meta:{model:"Video",size:(f.size/1e6).toFixed(1)+"MB"},resources:[]};else{const b=await f.arrayBuffer(),t=await extractText(b);m=parseMetadata(t)}const i={p,n:f.name,d:f.lastModified,m,v:vid};cache.set(p,i);dPut(i)}catch{}}

function setView(m){vMode=m;document.getElementById('bStats').classList.toggle('active',m==='stats');rend()}
function renderStats(container){const stats={models:new Map(),samplers:new Map(),loras:new Map(),sizes:new Map(),cfgs:new Map(),steps:new Map(),totalImages:0,aiImages:0};for(const [path,item] of cache.entries()){if(!item.m)continue;stats.totalImages++;const meta=item.m.meta||{};const resources=item.m.resources||[];if(meta.model&&meta.model!=="?"){stats.aiImages++;stats.models.set(meta.model,(stats.models.get(meta.model)||0)+1)}if(meta.sampler&&meta.sampler!=="?")stats.samplers.set(meta.sampler,(stats.samplers.get(meta.sampler)||0)+1);if(meta.size&&meta.size!=="?")stats.sizes.set(meta.size,(stats.sizes.get(meta.size)||0)+1);if(meta.cfg&&meta.cfg!=="?"){const cfg=parseFloat(meta.cfg);if(!isNaN(cfg)){const cfgKey=cfg.toFixed(1);stats.cfgs.set(cfgKey,(stats.cfgs.get(cfgKey)||0)+1)}}if(meta.steps&&meta.steps!=="?"){const steps=parseInt(meta.steps);if(!isNaN(steps))stats.steps.set(steps.toString(),(stats.steps.get(steps.toString())||0)+1)}resources.forEach(res=>{if(res.type==='LoRA'&&res.name)stats.loras.set(res.name,(stats.loras.get(res.name)||0)+1)})}const statsHtml=`<div style="padding:20px;max-width:1200px;margin:0 auto;"><h2 style="color:var(--txt);margin-bottom:30px;">üìä Metadata Statistics</h2><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;"><div class="stat-card"><h3>üìà Overview</h3><div class="stat-item">Total Images: <strong>${stats.totalImages}</strong></div><div class="stat-item">AI Images: <strong>${stats.aiImages}</strong></div><div class="stat-item">Non-AI Images: <strong>${stats.totalImages-stats.aiImages}</strong></div><div class="stat-item">AI Coverage: <strong>${stats.totalImages?Math.round((stats.aiImages/stats.totalImages)*100):0}%</strong></div></div><div class="stat-card"><h3>üé® Top Models</h3>${Array.from(stats.models.entries()).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([model,count])=>`<div class="stat-item">${model}: <strong>${count}</strong></div>`).join('')||'<div class="stat-item">No model data</div>'}</div><div class="stat-card"><h3>üîß Top LoRAs</h3>${Array.from(stats.loras.entries()).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([lora,count])=>`<div class="stat-item">${lora}: <strong>${count}</strong></div>`).join('')||'<div class="stat-item">No LoRA data</div>'}</div><div class="stat-card"><h3>‚öôÔ∏è Samplers</h3>${Array.from(stats.samplers.entries()).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([sampler,count])=>`<div class="stat-item">${sampler}: <strong>${count}</strong></div>`).join('')||'<div class="stat-item">No sampler data</div>'}</div><div class="stat-card"><h3>üìê Image Sizes</h3>${Array.from(stats.sizes.entries()).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([size,count])=>`<div class="stat-item">${size}: <strong>${count}</strong></div>`).join('')||'<div class="stat-item">No size data</div>'}</div><div class="stat-card"><h3>üéõÔ∏è CFG Scale</h3>${Array.from(stats.cfgs.entries()).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([cfg,count])=>`<div class="stat-item">${cfg}: <strong>${count}</strong></div>`).join('')||'<div class="stat-item">No CFG data</div>'}</div><div class="stat-card"><h3>üîÑ Steps</h3>${Array.from(stats.steps.entries()).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([steps,count])=>`<div class="stat-item">${steps}: <strong>${count}</strong></div>`).join('')||'<div class="stat-item">No steps data</div>'}</div></div></div>`;container.innerHTML=statsHtml}
function toggleTheme(){const body=document.body;const currentTheme=body.getAttribute('data-theme')||'dark';const newTheme=currentTheme==='dark'?'light':'dark';body.setAttribute('data-theme',newTheme);localStorage.setItem('guru-theme',newTheme);const toggleBtn=document.getElementById('themeToggle');if(toggleBtn){toggleBtn.textContent=newTheme==='dark'?'üåô':'‚òÄÔ∏è';toggleBtn.title=`Switch to ${newTheme==='dark'?'Light':'Dark'} Mode`}}
(function(){const savedTheme=localStorage.getItem('guru-theme')||'dark';document.body.setAttribute('data-theme',savedTheme);const toggleBtn=document.getElementById('themeToggle');if(toggleBtn){toggleBtn.textContent=savedTheme==='dark'?'üåô':'‚òÄÔ∏è';toggleBtn.title=`Switch to ${savedTheme==='dark'?'Light':'Dark'} Mode`}const savedFavorites=localStorage.getItem('guru-favorites');if(savedFavorites){favorites=new Set(JSON.parse(savedFavorites))}})();
function toggleFavorite(path){if(favorites.has(path)){favorites.delete(path)}else{favorites.add(path)}localStorage.setItem('guru-favorites',JSON.stringify([...favorites]));rend()}
async function findDuplicates(){showToast('Scanning for duplicates...','info');const hashMap=new Map();const duplicates=[];let processed=0;for(const [path,item] of cache.entries()){if(!item.h)continue;try{const file=await item.h.getFile();const arrayBuffer=await file.arrayBuffer();let hash=0;const view=new Uint8Array(arrayBuffer);for(let i=0;i<Math.min(view.length,50000);i++){hash=((hash<<5)-hash+view[i])&0xffffffff}hash=hash.toString(16);if(hashMap.has(hash)){duplicates.push({hash,files:[hashMap.get(hash),{path,name:item.n,size:file.size}]})}else{hashMap.set(hash,{path,name:item.n,size:file.size})}processed++;if(processed%10===0)showToast(`Scanned ${processed} files...`,'info')}catch(e){console.warn('Error hashing:',path,e)}}if(duplicates.length===0){showToast('No duplicates found!','success')}else{const msg=`Found ${duplicates.length} duplicate group(s). Check console for details.`;console.log('Duplicates:',duplicates);showToast(msg,'error');duplicates.forEach((group,idx)=>{console.log(`Group ${idx+1}:`,group.files.map(f=>f.name).join(', '))})}}
let contextTarget=null,contextPath="",contextIsFile=false;
function showContextMenu(e,element,path,isFile=false){e.preventDefault();contextTarget=element;contextPath=path;contextIsFile=isFile;const menu=document.getElementById('contextMenu');menu.style.display='block';menu.style.left=e.pageX+'px';menu.style.top=e.pageY+'px';document.addEventListener('click',hideContextMenu,{once:true})}
function hideContextMenu(){document.getElementById('contextMenu').style.display='none';contextTarget=null;contextPath="";contextIsFile=false}
async function contextDelete(){if(!contextPath)return;const name=contextPath.split('/').pop();if(!confirm(`Delete "${name}"? This cannot be undone.`))return;try{if(contextIsFile){const parentPath=contextPath.includes('/')?contextPath.substring(0,contextPath.lastIndexOf('/')):"";const parentHandle=parentPath?dReg.get(parentPath)||rH:rH;await parentHandle.removeEntry(name);fReg.delete(contextPath);cache.delete(contextPath);await dDel(contextPath)}else{const parentPath=contextPath.includes('/')?contextPath.substring(0,contextPath.lastIndexOf('/')):"";const parentHandle=parentPath?dReg.get(parentPath)||rH:rH;await parentHandle.removeEntry(name);dReg.delete(contextPath)}await fullScan();showToast('Deleted successfully','success')}catch(e){showToast('Delete failed: '+e.message,'error')}hideContextMenu()}
function showHelp(){const content=document.getElementById('helpContent');content.innerHTML=`<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;"><div><h3 style="color:var(--acc);margin-top:0;">‚å®Ô∏è Keyboard Shortcuts</h3><div style="display:grid;gap:8px;font-size:0.9rem;"><div><kbd>Arrow Keys</kbd> Navigate in detail view</div><div><kbd>Enter</kbd> Open selected image</div><div><kbd>Delete</kbd> Delete selected item</div><div><kbd>Esc</kbd> Close overlays / Exit detail</div><div><kbd>3</kbd> Statistics view</div><div><kbd>S</kbd> Statistics view</div><div><kbd>T</kbd> Toggle theme</div><div><kbd>?</kbd> Show this help</div><div><kbd>F</kbd> Focus search</div><div><kbd>R</kbd> Refresh folder</div></div></div><div><h3 style="color:var(--acc);margin-top:0;">üñ±Ô∏è Mouse Actions</h3><div style="display:grid;gap:8px;font-size:0.9rem;"><div><strong>Click</strong> Image to view details</div><div><strong>Right-click</strong> File/Folder for context menu</div><div><strong>Drag & Drop</strong> Files to move between folders</div><div><strong>Click Star</strong> ‚≠ê to favorite/unfavorite</div><div><strong>Ctrl+Click</strong> Select multiple (coming soon)</div><div><strong>Shift+Click</strong> Range select (coming soon)</div></div></div><div><h3 style="color:var(--acc);margin-top:0;">üìã Functions</h3><div style="display:grid;gap:8px;font-size:0.9rem;"><div><strong>Open Folder</strong> Select folder to browse</div><div><strong>‚Üª Refresh</strong> Rescan folder for new files</div><div><strong>Search</strong> Filter images by name/metadata</div><div><strong>Statistics</strong> View metadata analytics</div><div><strong>Theme Toggle</strong> Switch dark/light mode</div><div><strong>Favorites</strong> Star images for quick access</div><div><strong>Delete</strong> Remove files/folders (right-click)</div></div></div><div><h3 style="color:var(--acc);margin-top:0;">üéØ Tips</h3><div style="display:grid;gap:8px;font-size:0.9rem;"><div>‚Ä¢ Use drag-and-drop to organize files</div><div>‚Ä¢ Right-click folders for context menu</div><div>‚Ä¢ Statistics view shows metadata insights</div><div>‚Ä¢ Favorites persist across sessions</div><div>‚Ä¢ Search works on filenames and metadata</div><div>‚Ä¢ Theme preference is saved automatically</div></div></div></div>`;document.getElementById('helpOverlay').classList.remove('hidden')}
function hideHelp(){document.getElementById('helpOverlay').classList.add('hidden')}
function showToast(message,type='info'){const toast=document.createElement('div');toast.className=`toast ${type}`;const closeBtn=document.createElement('button');closeBtn.textContent='‚úï';closeBtn.style.cssText='background:none;border:none;color:var(--txt);cursor:pointer;font-size:1.2rem;';closeBtn.onclick=()=>toast.remove();toast.innerHTML=`<div style="flex:1;">${message}</div>`;toast.appendChild(closeBtn);document.body.appendChild(toast);setTimeout(()=>{toast.style.animation='toastSlide 0.3s ease reverse';setTimeout(()=>toast.remove(),300)},3000)}
function rTree(){const c=document.getElementById('tree');c.innerHTML='';const a=document.createElement('div');a.className='folder active';a.innerText='üìÅ All Files';a.ondragover=e=>{e.preventDefault();a.classList.add('drag-over')};a.ondragleave=()=>a.classList.remove('drag-over');a.ondrop=e=>{e.preventDefault();a.classList.remove('drag-over');moveFile(e.dataTransfer.getData("text"),"")};a.onclick=()=>{document.querySelectorAll('.folder').forEach(e=>e.classList.remove('active'));a.classList.add('active');opD(null,"")};a.oncontextmenu=e=>{e.preventDefault();showContextMenu(e,a,"")};c.appendChild(a);[...dReg.keys()].sort().forEach(p=>{if(!p)return;const d=document.createElement('div');d.className='folder';d.innerText="üìÅ "+p.split('/').pop();d.style.paddingLeft=(p.split('/').length*16)+'px';d.ondragover=e=>{e.preventDefault();d.classList.add('drag-over')};d.ondragleave=()=>d.classList.remove('drag-over');d.ondrop=e=>{e.preventDefault();d.classList.remove('drag-over');moveFile(e.dataTransfer.getData("text"),p)};d.onclick=()=>{document.querySelectorAll('.folder').forEach(e=>e.classList.remove('active'));d.classList.add('active');opD(dReg.get(p),p)};d.oncontextmenu=e=>{e.preventDefault();showContextMenu(e,d,p)};c.appendChild(d)})}
async function opD(h,p){cDir=h;const pathText=p||"All Files";const displayText=showFavoritesOnly?`${pathText} (Favorites Only)`:pathText;document.getElementById('pathDisplay').innerText=displayText;cFiles=[];for(const [fp,fh] of fReg.entries()){const par=fp.includes('/')?fp.substring(0,fp.lastIndexOf('/')):"";if(!h||par===p){const item=cache.get(fp)||{};const fileInfo={p:fp,h:fh,d:item.d||0,n:item.n||fh.name};if(showFavoritesOnly&&!favorites.has(fp))continue;cFiles.push(fileInfo)}}await applySort();rend()}
async function applySort(){
    if(sortBy==='name'){
        cFiles.sort((a,b)=>{
            const cmp=a.n.localeCompare(b.n);
            return sortDirection==='asc'?cmp:-cmp;
        });
    }else if(sortBy==='model'){
        cFiles.sort((a,b)=>{
            const mtA=cache.get(a.p)||{},mmA=(mtA.m&&mtA.m.meta)?mtA.m.meta:{};
            const mtB=cache.get(b.p)||{},mmB=(mtB.m&&mtB.m.meta)?mtB.m.meta:{};
            const modelA=(mmA.model||"").toLowerCase();
            const modelB=(mmB.model||"").toLowerCase();
            const cmp=modelA.localeCompare(modelB);
            return sortDirection==='asc'?cmp:-cmp;
        });
    }else if(sortBy==='modified'){
        cFiles.sort((a,b)=>{
            const cmp=(b.d||0)-(a.d||0);
            return sortDirection==='asc'?-cmp:cmp;
        });
    }else if(sortBy==='created'){
        for(const f of cFiles){if(!f.created){try{const file=await f.h.getFile();f.created=file.lastModified}catch(e){f.created=0}}}
        cFiles.sort((a,b)=>{
            const cmp=(b.created||0)-(a.created||0);
            return sortDirection==='asc'?-cmp:cmp;
        });
    }else{
        cFiles.sort((a,b)=>{
            const cmp=(b.d||0)-(a.d||0);
            return sortDirection==='asc'?-cmp:cmp;
        });
    }
}
function sortByColumn(col){
    if(sortBy===col){
        sortDirection=sortDirection==='asc'?'desc':'asc';
    }else{
        sortBy=col;
        sortDirection='asc';
    }
    applySort().then(()=>rend());
}
function getSortArrow(col){
    if(sortBy===col)return sortDirection==='asc'?'‚Üë':'‚Üì';
    return'<span class="sort-arrow">‚Üï</span>';
}
async function changeSort(){
    const val=document.getElementById('sortSelect').value;
    if(val==='name'){sortBy='name';sortDirection='asc'}
    else if(val==='created'){sortBy='created';sortDirection='desc'}
    else{sortBy='date';sortDirection='desc'}
    await applySort();rend();
}
async function toggleFavoritesFilter(){showFavoritesOnly=!showFavoritesOnly;const btn=document.getElementById('favFilterBtn');btn.classList.toggle('active',showFavoritesOnly);btn.title=showFavoritesOnly?'Show All Files':'Show Only Favorites';let currentPath=document.getElementById('pathDisplay').innerText.replace(' (Favorites Only)','');if(currentPath==='All Files')currentPath=null;await opD(cDir,currentPath)}

function rend(){
    const c=document.getElementById('grid');c.innerHTML='';c.className=vMode==='stats'?'stats-view':'list-view';document.getElementById('fCount').innerText=`${cFiles.length} items`;
    if(vMode==='stats'){renderStats(c);return}
    const h=document.createElement('div');h.className='list-head';
    h.innerHTML=`<div></div><div class="sortable ${sortBy==='name'?'sorted':''}" onclick="sortByColumn('name')">Name ${getSortArrow('name')}</div><div class="sortable ${sortBy==='model'?'sorted':''}" onclick="sortByColumn('model')">Model ${getSortArrow('model')}</div><div class="sortable ${sortBy==='modified'?'sorted':''}" onclick="sortByColumn('modified')">Date Modified ${getSortArrow('modified')}</div><div class="sortable ${sortBy==='created'?'sorted':''}" onclick="sortByColumn('created')">Date Created ${getSortArrow('created')}</div>`;
    c.appendChild(h);
    cFiles.forEach((f,i)=>{
        const mt=cache.get(f.p)||{},mm=(mt.m&&mt.m.meta)?mt.m.meta:{},div=document.createElement('div');
        div.draggable=true;
        div.ondragstart=e=>{e.dataTransfer.setData("text",f.p);e.dataTransfer.effectAllowed="move"};
        const isSelected=selectedIndex===i||selectedItems.has(f.p);
        const formatDate=(d)=>{if(!d)return"";const dt=new Date(d);return dt.toLocaleDateString()+" "+dt.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})};
        const dateModified=f.d?formatDate(f.d):"";
        let dateCreated="";
        if(f.created){dateCreated=formatDate(f.created)}else{dateCreated="Loading...";f.h.getFile().then(x=>{f.created=x.lastModified;const createdCell=div.querySelector('.date-created');if(createdCell)createdCell.textContent=formatDate(f.created)})}
        div.className=`list-row${isSelected?' selected':''}`;if(isSelected)div.style.backgroundColor='rgba(139,92,246,0.2)';const tag=mt.v?'video':'img';div.innerHTML=`<${tag} class="list-img"></${tag}><div>${f.h.name}</div><div>${mm.model||""}</div><div class="date-modified">${dateModified}</div><div class="date-created">${dateCreated}</div>`;f.h.getFile().then(x=>{div.querySelector(tag).src=URL.createObjectURL(x)});
        div.onclick=(e)=>{if(e.ctrlKey){selectedItems.has(f.p)?selectedItems.delete(f.p):selectedItems.add(f.p);rend()}else if(e.shiftKey&&selectedIndex>=0){const start=Math.min(selectedIndex,i);const end=Math.max(selectedIndex,i);for(let j=start;j<=end;j++)selectedItems.add(cFiles[j].p);rend()}else{selectedIndex=i;selectedItems.clear();selectedItems.add(f.p);enterDet(i)}};div.oncontextmenu=(e)=>{e.preventDefault();showContextMenu(e,div,f.p,true)};c.appendChild(div)
    })
}

// MOVE ENGINE
async function moveFile(srcPath, destFolder){
    if(!srcPath || srcPath===destFolder) return;
    const fName = srcPath.split('/').pop();
    const newPath = destFolder ? `${destFolder}/${fName}` : fName;
    if(srcPath === newPath) return;
    try {
        const srcHandle = fReg.get(srcPath);
        const file = await srcHandle.getFile();
        const destHandle = dReg.get(destFolder) || rH;
        const newFileHandle = await destHandle.getFileHandle(fName, { create: true });
        const writable = await newFileHandle.createWritable();
        await writable.write(file);
        await writable.close();
        const srcParent = srcPath.includes('/') ? srcPath.substring(0, srcPath.lastIndexOf('/')) : "";
        const srcParentHandle = dReg.get(srcParent) || rH;
        await srcParentHandle.removeEntry(fName);
        const meta = cache.get(srcPath);
        cache.delete(srcPath); fReg.delete(srcPath); await dDel(srcPath);
        fReg.set(newPath, newFileHandle);
        const newItem = { ...meta, p: newPath };
        cache.set(newPath, newItem); await dPut(newItem);
        alert(`Moved to ${destFolder||"Root"}`);
        await opD(cDir, document.getElementById('pathDisplay').innerText);
    } catch(e) { console.error(e); alert("Move failed: "+e.message); }
}

async function enterDet(i){aIdx=i;document.body.className='mode-detail';document.getElementById('detailView').classList.add('active');document.getElementById('sidebar').classList.add('collapsed');upDet()}
function exitDetail(){document.body.className='mode-list';document.getElementById('detailView').classList.remove('active');document.getElementById('sidebar').classList.remove('collapsed');document.getElementById('inspector').classList.remove('open')}
function togInsp(f){const i=document.getElementById('inspector');if(f!==undefined)i.classList.toggle('open',f);else i.classList.toggle('open')}
async function upDet(){
    if(aIdx<0||aIdx>=cFiles.length)return;
    const f=cFiles[aIdx],mt=cache.get(f.p);cItem=f;
    const con=document.getElementById('mediaCon');con.innerHTML='';
    const fl=await f.h.getFile(),u=URL.createObjectURL(fl),el=document.createElement(mt.v?'video':'img');
    el.src=u;el.className='detail-media';if(mt.v){el.controls=true;el.autoplay=true}con.appendChild(el);
    const starBtn=document.getElementById('detailFavoriteStar');
    if(starBtn){
        const isFavorite=favorites.has(f.p);
        starBtn.textContent=isFavorite?'‚≠ê':'‚òÜ';
        starBtn.classList.toggle('favorited',isFavorite);
    }
    pop(f,mt);
}
function toggleFavoriteFromDetail(){
    if(aIdx<0||aIdx>=cFiles.length)return;
    const f=cFiles[aIdx];
    toggleFavorite(f.p);
    const starBtn=document.getElementById('detailFavoriteStar');
    if(starBtn){
        const isFavorite=favorites.has(f.p);
        starBtn.textContent=isFavorite?'‚≠ê':'‚òÜ';
        starBtn.classList.toggle('favorited',isFavorite);
    }
}
function pop(f,mt){
    document.getElementById('mFile').innerText=f.h.name;
    const m=(mt.m&&mt.m.meta)?mt.m.meta:(mt.m||{}),r=mt.m||{};
    const set=(i,v)=>document.getElementById(i).value=v||"";
    set('mModel',m.model);set('mSize',m.size);set('mSamp',m.sampler);set('mSeed',m.seed);set('mSteps',m.steps);set('mCfg',m.cfg);set('mPos',r.pos);set('mNeg',r.neg);
    const b=document.getElementById('mRes');b.innerHTML='';
    if(r.resources)r.resources.forEach(x=>{
        const s=document.createElement('span');s.className='chip';
        s.innerHTML = x.name + (x.str ? ` <span style="opacity:0.6;font-size:0.9em">| ${x.str}</span>` : "");
        b.appendChild(s)
    });
    if(document.body.classList.contains('mode-list'))togInsp(true);
}
function nav(d){const n=aIdx+d;if(n>=0&&n<cFiles.length){aIdx=n;upDet()}}
document.addEventListener('keydown',e=>{
    if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA'){if(e.key==='Escape'){e.target.blur();hideHelp()}return}
    if(document.body.classList.contains('mode-detail')){if(e.key==='ArrowRight')nav(1);if(e.key==='ArrowLeft')nav(-1);if(e.key==='Escape')exitDetail();return}
    if(e.key==='?'||(e.shiftKey&&e.key==='?')){e.preventDefault();showHelp();return}
    if(e.key==='Escape'){hideHelp();return}
    if(e.key==='Enter'&&selectedIndex>=0&&selectedIndex<cFiles.length){enterDet(selectedIndex);return}
    if(e.key==='Delete'&&selectedItems.size>0){if(confirm(`Delete ${selectedItems.size} item(s)?`)){selectedItems.forEach(p=>{const name=p.split('/').pop();const parentPath=p.includes('/')?p.substring(0,p.lastIndexOf('/')):"";const parentHandle=parentPath?dReg.get(parentPath)||rH:rH;parentHandle.removeEntry(name).then(()=>{fReg.delete(p);cache.delete(p);dDel(p)}).catch(e=>console.error(e))});selectedItems.clear();setTimeout(()=>fullScan(),500);rend()};return}
    if(e.key==='f'||e.key==='F'){if(!e.ctrlKey){e.preventDefault();document.getElementById('sIn').focus();return}}
    if(e.key==='r'||e.key==='R'){if(!e.ctrlKey){e.preventDefault();fullScan();return}}
    if(e.key==='t'||e.key==='T'){if(!e.ctrlKey){e.preventDefault();toggleTheme();return}}
    if(e.key==='3'){e.preventDefault();setView('stats');return}
    if(e.key==='s'||e.key==='S'){if(!e.ctrlKey){e.preventDefault();setView('stats');return}}
    if(vMode==='list'&&cFiles.length>0){if(e.key==='ArrowDown'){e.preventDefault();selectedIndex=Math.min(selectedIndex+1,cFiles.length-1);rend();scrollToSelected();return}
    if(e.key==='ArrowUp'){e.preventDefault();selectedIndex=Math.max(selectedIndex-1,0);rend();scrollToSelected();return}
    if(e.key==='Home'){e.preventDefault();selectedIndex=0;rend();scrollToSelected();return}
    if(e.key==='End'){e.preventDefault();selectedIndex=cFiles.length-1;rend();scrollToSelected();return}}
})
function scrollToSelected(){if(selectedIndex>=0){const cards=document.querySelectorAll('.card, .list-row');if(cards[selectedIndex]){cards[selectedIndex].scrollIntoView({behavior:'smooth',block:'center'})}}}

const crT=[];for(let n=0;n<256;n++){let c=n;for(let k=0;k<8;k++)c=(c&1)?(0xedb88320^(c>>>1)):(c>>>1);crT[n]=c}
const cr32=b=>{let c=0xffffffff;for(let i=0;i<b.length;i++)c=crT[(c^b[i])&0xff]^(c>>>8);return c^0xffffffff};
async function fixSave(){
    if(!cItem)return;
    const pos=document.getElementById('mPos').value.replace(/\n/g," "),neg=document.getElementById('mNeg').value.replace(/\n/g," ");
    const txt=`${pos}\nNegative prompt: ${neg}\nSteps: ${document.getElementById('mSteps').value}, Sampler: ${document.getElementById('mSamp').value}, CFG scale: ${document.getElementById('mCfg').value}, Seed: ${document.getElementById('mSeed').value}, Size: ${document.getElementById('mSize').value}, Model: ${document.getElementById('mModel').value}`;
    try{
        const f=await cItem.h.getFile();let b=await f.arrayBuffer(),v=new DataView(b.slice(0,8));
        if(!(v.getUint32(0)===0x89504E47&&v.getUint32(4)===0x0D0A1A0A)){const i=new Image();i.src=URL.createObjectURL(f);await new Promise(r=>i.onload=r);const c=document.createElement('canvas');c.width=i.width;c.height=i.height;c.getContext('2d').drawImage(i,0,0);b=await new Promise(r=>c.toBlob(z=>z.arrayBuffer().then(r),'image/png'))}
        const ch=[];let o=8;v=new DataView(b);ch.push(b.slice(0,8));
        while(o<b.byteLength){const l=v.getUint32(o),ty=String.fromCharCode(...new Uint8Array(b,o+4,4)),sz=12+l;if(o+sz>b.byteLength||ty==='IEND')break;let kp=true;if(ty==='tEXt'||ty==='iTXt'){const kw=new Uint8Array(b,o+8,Math.min(l,20));let s="";for(let k=0;k<kw.length;k++){if(kw[k]===0)break;s+=String.fromCharCode(kw[k])}if(["parameters","prompt","workflow","ComfyUI"].includes(s))kp=false}if(kp)ch.push(b.slice(o,o+sz));o+=sz}
        const enc=new TextEncoder(),k=enc.encode("parameters\0"),val=enc.encode(txt),dt=new Uint8Array(k.length+val.length);dt.set(k);dt.set(val,k.length);
        const ln=dt.length,tp=enc.encode("tEXt"),cd=new Uint8Array(4+ln);cd.set(tp);cd.set(dt,4);
        const fc=new Uint8Array(12+ln),fv=new DataView(fc.buffer);fv.setUint32(0,ln);fc.set(tp,4);fc.set(dt,8);fv.setUint32(8+ln,cr32(cd));
        ch.push(fc);ch.push(new Uint8Array([0,0,0,0,0x49,0x45,0x4E,0x44,0xAE,0x42,0x60,0x82]));
        const nn="fixed_"+f.name.replace(/\.[^/.]+$/,".png"),par=cItem.p.includes('/')?cItem.p.substring(0,cItem.p.lastIndexOf('/')):"";
        const d=dReg.get(par)||rH,nh=await d.getFileHandle(nn,{create:true}),w=await nh.createWritable();
        await w.write(new Blob(ch,{type:'image/png'}));await w.close();
        const np=par?`${par}/${nn}`:nn;fReg.set(np,nh);await proc(nh,np);alert("Saved!");await opD(cDir,document.getElementById('pathDisplay').innerText);
    }catch(e){console.error(e);alert("Error: "+e.message)}
}
async function mkDir(){
    if(!rH) return alert("Please open a folder first.");
    const n=prompt("Name");
    if(n){
        try {
            const target = cDir || rH; 
            await target.getDirectoryHandle(n,{create:true});
            await fullScan();
        } catch(e) { alert("Create failed: "+e.message); }
    }
}
function saveJSON(){if(!cItem)return;const d={filename:document.getElementById('mFile').innerText,positive:document.getElementById('mPos').value,negative:document.getElementById('mNeg').value,meta:{model:document.getElementById('mModel').value,seed:document.getElementById('mSeed').value}};const b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'}),a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=d.filename+".json";a.click()}
document.getElementById('sIn').addEventListener('input',async e=>{
    const t=e.target.value.toLowerCase().trim();
    if(!t){
        await opD(cDir,cDir===rH?"":Array.from(dReg.entries()).find(([k,v])=>v===cDir)?.[0]||"");
        return;
    }
    const a=[];
    for(const[p,v]of cache){
        if(!v)continue;
        const fh=fReg.get(p);
        if(!fh)continue;
        let matches=false;
        const fileName=(v.n||'').toLowerCase();
        if(fileName.includes(t)){matches=true}
        if(!matches&&v.m){
            const m=v.m;
            if(m.pos&&m.pos.toLowerCase().includes(t)){matches=true}
            if(!matches&&m.neg&&m.neg.toLowerCase().includes(t)){matches=true}
            if(!matches&&m.meta){
                const meta=m.meta;
                if(meta.model&&meta.model.toLowerCase().includes(t)){matches=true}
                if(!matches&&meta.sampler&&meta.sampler.toLowerCase().includes(t)){matches=true}
                if(!matches&&meta.seed&&meta.seed.toString().includes(t)){matches=true}
                if(!matches&&meta.steps&&meta.steps.toString().includes(t)){matches=true}
                if(!matches&&meta.cfg&&meta.cfg.toString().includes(t)){matches=true}
                if(!matches&&meta.size&&meta.size.toLowerCase().includes(t)){matches=true}
            }
            if(!matches&&m.resources&&Array.isArray(m.resources)){
                for(const r of m.resources){
                    if(r.name&&r.name.toLowerCase().includes(t)){matches=true;break}
                }
            }
        }
        if(matches){a.push({p,h:fh,d:v.d||0,n:v.n||fh.name})}
    }
    cFiles=a;
    await applySort();
    rend();
});
</script></body></html>